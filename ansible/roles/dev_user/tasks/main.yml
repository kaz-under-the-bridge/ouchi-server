---
- name: "{{ dev_user_name }} ユーザーの作成"
  ansible.builtin.user:
    name: "{{ dev_user_name }}"
    uid: "{{ dev_user_uid }}"
    shell: "{{ dev_user_shell }}"
    groups: "{{ dev_user_groups }}"
    append: true
    create_home: true

- name: "{{ dev_user_name }} の sudo パスワードなし設定"
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ dev_user_name }}"
    content: "{{ dev_user_name }} ALL=(ALL) NOPASSWD:ALL\n"
    mode: "0440"
    validate: "visudo -cf %s"

- name: "{{ dev_user_name }} の .ssh ディレクトリ作成"
  ansible.builtin.file:
    path: "/home/{{ dev_user_name }}/.ssh"
    state: directory
    owner: "{{ dev_user_name }}"
    group: "{{ dev_user_name }}"
    mode: "0700"

- name: "{{ dev_user_name }} の authorized_keys を配置"
  ansible.builtin.copy:
    dest: "/home/{{ dev_user_name }}/.ssh/authorized_keys"
    content: "{{ ssh_public_key }}\n"
    owner: "{{ dev_user_name }}"
    group: "{{ dev_user_name }}"
    mode: "0600"

- name: "{{ dev_user_name }} の git ディレクトリ作成 (NFS マウントポイント)"
  ansible.builtin.file:
    path: "/home/{{ dev_user_name }}/git"
    state: directory
    owner: "{{ dev_user_name }}"
    group: "{{ dev_user_name }}"
    mode: "0755"

- name: keychain のインストール
  ansible.builtin.apt:
    name: keychain
    state: present

- name: github.com を known_hosts に追加
  ansible.builtin.known_hosts:
    path: "/home/{{ dev_user_name }}/.ssh/known_hosts"
    name: github.com
    key: "{{ lookup('pipe', 'ssh-keyscan -t ed25519 github.com 2>/dev/null') }}"
    state: present
  become_user: "{{ dev_user_name }}"

- name: ssh-agent 自動起動の設定 (.bashrc)
  ansible.builtin.blockinfile:
    path: "/home/{{ dev_user_name }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED - ssh-agent"
    block: |
      eval "$(keychain --eval --agents ssh id_rsa 2>/dev/null)"
    create: true
    owner: "{{ dev_user_name }}"
    group: "{{ dev_user_name }}"
    mode: "0644"
