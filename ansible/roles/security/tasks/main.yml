---
# --- SSH 強化 ---
- name: sshd_config を配置
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: "0644"
    validate: "sshd -t -f %s"
  notify: sshd を再起動

# --- UFW ---
- name: UFW のインストール
  ansible.builtin.apt:
    name: ufw
    state: present

- name: UFW デフォルトポリシー (incoming deny)
  community.general.ufw:
    direction: incoming
    default: deny

- name: UFW デフォルトポリシー (outgoing allow)
  community.general.ufw:
    direction: outgoing
    default: allow

- name: UFW 許可ルールの適用
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
  loop: "{{ ufw_allowed_ports }}"

- name: UFW を有効化
  community.general.ufw:
    state: enabled

# --- fail2ban ---
- name: fail2ban のインストール
  ansible.builtin.apt:
    name: fail2ban
    state: present

- name: fail2ban を有効化・起動
  ansible.builtin.systemd:
    name: fail2ban
    enabled: true
    state: started
